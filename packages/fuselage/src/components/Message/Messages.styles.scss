@use '../../styles/lengths.scss';
@use '../../styles/functions.scss';
@use '../../styles/colors.scss';
@use '../../styles/mixins/size.scss';
@use '../../styles/mixins/templates.scss';
@use '../../styles/typography.scss';
@use './mixins.scss';

@import './MessageMetrics/MessageMetrics.styles.scss';
@import './MessageToolbar/MessageToolbar.styles.scss';
@import './MessageReactions/MessageReactions.styles.scss';
@import './ThreadMessage/ThreadMessage.styles.scss';
@import './MessageDivider/MessageDivider.styles.scss';
@import './MessageStatusIndicator/MessageStatusIndicator.styles.scss';
@import './MessageSystem/MessageSystem.styles.scss';
@import './MessageGenericPreview/MessageGenericPreview.styles.scss';

%rcx-margins-header {
  margin-inline: lengths.margin(2);
}
%rcx-margins-block {
  margin-block: lengths.margin(2);
}

$message-background-color: functions.theme(
  'message-background-color',
  colors.surface(room)
);

$message-background-color-hover: functions.theme(
  'message-background-color-hover',
  colors.surface(hover)
);

$message-background-color-selected: functions.theme(
  'message-background-color-selected',
  colors.surface(selected)
);

$message-background-color-editing: functions.theme(
  'message-background-color-editing',
  colors.status-background(warning-2)
);
$message-color-editing: functions.theme(
  'message-background-color-editing',
  colors.status-font(on-warning-2)
);

$message-background-color-highlight: functions.theme(
  'message-background-color-highlight',
  colors.status-background(warning-2)
);

.rcx-message {
  @include mixins.container();
  position: relative;

  display: flex;
  flex-direction: row;
  align-items: flex-start;

  margin-inline: lengths.margin(2);
  padding-block: lengths.padding(8) lengths.padding(4);
  padding-inline: lengths.padding(20);

  // Focus visible for keyboard accessibility
  &:focus-visible {
    @include templates.focus-state;
    background-color: $message-background-color-hover;
    outline: 2px solid colors.stroke(medium);
    outline-offset: -2px;
  }

  &:hover {
    background-color: $message-background-color-hover;
  }

  &--selected {
    background: $message-background-color-selected !important;
  }

  &--editing {
    color: $message-color-editing !important;
    background: $message-background-color-editing !important;
  }

  &--highlight {
    animation: background-fade 6s forwards;
  }

  &--pending {
    .rcx-message-body {
      opacity: 0.4;
    }
  }

  &--sequential {
    padding-block: lengths.padding(4);
  }

  &--clickable {
    cursor: pointer;
    user-select: none;
    
    &:focus {
      @include templates.focus-state;
    }
  }

  &-header {
    @extend %rcx-margins-block;
    display: flex;
    flex-direction: row;
    flex-grow: 0;
    flex-shrink: 1;
    min-width: 1px;
    
    // Accessibility: Ensure header text scales responsively
    font-size: clamp(0.75rem, 1vw, 0.875rem);
  }

  &-body {
    @extend %rcx-margins-block;
    @include typography.use-font-scale(p2);
    // Responsive Typography
    font-size: clamp(0.875rem, 1vw, 1rem);

    overflow: hidden;
    flex-shrink: 1;
    transition: opacity 0.3s linear;
    word-break: break-word;
    opacity: 1;
    color: colors.font(default);

    blockquote {
      padding-inline: lengths.padding(8);
      border: 1px solid colors.stroke(extra-light);
      border-radius: lengths.border-radius(small);
      background-color: colors.surface(tint);
      border-inline-start: 4px solid colors.stroke(medium);
    }
  }

  &-block {
    @extend %rcx-margins-block;
    display: flex;
    flex-direction: column;

    &--width-fixed {
      flex-grow: 0;
      flex-shrink: 1;
      // Refactored using clamp() for responsiveness
      width: 100%;
      max-width: clamp(280px, 50vw, 368px);
    }
  }

  &__emoji {
    display: inline-block;
    margin-inline: lengths.margin(2);
    background-size: contain;
    @include size.square(lengths.size(24));

    &--big {
      @include size.square(lengths.size(44));
    }
  }
}

@keyframes background-fade {
  50% { background: $message-background-color-highlight; }
  100% { background: $message-background-color; }
}